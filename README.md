# ðŸš€ Image processor

A simple microservice to process image EXIF metadata and compare it with control points.

## Table of Contents

- [Goals](#goals)
- [Folder structure](#folder-structure)
- [Available Scripts](#available-scripts)
  - [npm start](#npm-start)
- [Docker](#docker)
  - [Build the image](#build-the-image)
  - [Run the image](#run-the-image)
  - [Get container logs](#get-container-logs)
  - [Copy files from container](#copy-files-from-container)

## Goals

* To have a microservice that reads jpg images from a given directory to be processed.
* To have a microservice that gets EXIF metadata from jpg images.
* To have a microservice that reads control points coordenates from a given csv file.
* To have a microservice that compares the coordenates from the jpg images and the control points to identify those points outside of the images area.

## Folder structure

The folder structure we follow for the project is as shown below.

```
image-processor/
  .circleci/
    config.yml
  controlpoints/
    controlPoints.csv
  images/
    image-001.jpg
    image-002.jpg
    image-003.jpg
    ...
  .dockerignore
  .eslintrc.json
  .gitignore
  .nvmrc
  Dockerfile
  index.js
  package-lock.json
  package.json
  README.md
```

**Note**: The directories controlpoints/ and images/ are included in .gitignore for simplicity.

## Available Scripts

In the project directory, you can run:

### `npm start`

Runs the app and starts the cron job, current configuration is to run it every minute.

Output should be displayed on the terminal where the script is running.

### `npm run lint`

Runs the linter, current rules are based on Airbnb practices.

## Docker

The app can use docker to run inside a container.

### Build the image

Go to the directory that has your `Dockerfile` and run the following command to build the Docker image. The `-t` flag lets you tag your image so it's easier to find later using the `docker images` command:

```
$ docker build -t <your username>/node-image-processor .
```

Your image will now be listed by Docker:

```
$ docker images

# Example
REPOSITORY                              TAG        ID              CREATED
node                                    8          1934b0b038d1    5 days ago
<your username>/node-image-processor    latest     d64d3505b0d2    1 minute ago
```

### Run the image

Running your image with `-d` runs the container in detached mode, leaving the container running in the background. 

```
docker run -d <your username>/node-image-processor
```

### Get container logs

Print the output of your app:

```
# Get container ID
$ docker ps

# Print app output
$ docker logs <container id>

# Example
2019-01-06T19:02:00+00:00 - Start processing images and control points
2019-01-06T19:02:00+00:00 - Images and control points processed, results saved to data-2019-01-06T19:02:00+00:00.json
2019-01-06T19:03:00+00:00 - Start processing images and control points
2019-01-06T19:03:00+00:00 - Images and control points processed, results saved to data-2019-01-06T19:03:00+00:00.json
```

### Copy files from container

To copy the files generated by the cron job, you can do this:

```
# Print files inside container
docker exec <container id> ls /usr/src/app

# Example
Dockerfile
controlpoints
data-2019-01-06T19:07:00+00:00.json
images
index.js
node_modules
package-lock.json
package.json

# Copy files generated by the cron job
docker cp <containerId>:/usr/src/app/data-{timestamp}.json /host/path/target

# Example
docker cp 746bdacdfb9b:/usr/src/app/data-2019-01-06T19:07:00+00:00.json ~/image-processor/results
```
